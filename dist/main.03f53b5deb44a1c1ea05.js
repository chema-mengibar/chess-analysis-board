(()=>{"use strict";class e{constructor(e){this.letterW=e.letterW,this.iconW=e.iconW,this.letterB=e.letterB,this.iconB=e.iconB}asLetter(e=!0){return e?this.letterW:this.letterB}asIcon(e=!0){return e?this.iconW:this.iconB}}const t=[8,7,6,5,4,3,2,1],r=["a","b","c","d","e","f","g","h"],a=!0,o=!1,s="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",n={b:new e({letterW:"B",iconW:"♗",letterB:"b",iconB:"♝"}),r:new e({letterW:"R",iconW:"♖",letterB:"r",iconB:"♜"}),n:new e({letterW:"N",iconW:"♘",letterB:"n",iconB:"♞"}),k:new e({letterW:"K",iconW:"♔",letterB:"k",iconB:"♚"}),q:new e({letterW:"Q",iconW:"♕",letterB:"q",iconB:"♛"}),p:new e({letterW:"P",iconW:"♙",letterB:"p",iconB:"♟"})};class i{constructor(e){this.buffer={squareTarget:null},this.callBacks=e,this.panelControls()}squareControls(){const e=this;document.querySelectorAll(".square").forEach((t=>{t.addEventListener("click",(function(t){const r=(t.target||t.srcElement).getAttribute("data-square");e.checkOnSelectSquare(r)}),!1)}))}async checkOnSelectSquare(e){this.buffer.squareTarget?e===this.buffer.squareTarget||this.callBacks.movePiecesFromSquares(this.buffer.squareTarget,e)?this.clearBufferAndSelection():(this.clearSelectedSquareFromBuffer(),this.setBufferSquareTarget(e)):this.setBufferSquareTarget(e)}panelControls(){const e=this;document.querySelectorAll(".button-add-fig").forEach((t=>{t.addEventListener("click",(function(t){const r=(t.target||t.srcElement).getAttribute("data-letter"),a=r===r.toUpperCase();e.callBacks.onAdd(e.buffer.squareTarget,r.toLowerCase(),a),e.clearSelectedSquareFromBuffer()}),!1)})),document.querySelectorAll(".button-marker").forEach((t=>{t.addEventListener("click",(function(t){const r=t.currentTarget.getAttribute("data-marker-id");e.callBacks.onAddMarker(e.buffer.squareTarget,r),e.clearSelectedSquareFromBuffer()}),!1)})),document.getElementById("button-clear-square").addEventListener("click",(function(){e.callBacks.onClearSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-domains-w").addEventListener("click",(function(){e.callBacks.onDomainW()}),!1),document.getElementById("button-paint-domains-b").addEventListener("click",(function(){e.callBacks.onDomainB()}),!1),document.getElementById("button-clear").addEventListener("click",(function(){e.callBacks.onClear()}),!1),document.getElementById("button-init").addEventListener("click",(function(){e.callBacks.onInit()}),!1),document.getElementById("button-toggle-domains").addEventListener("click",(function(){e.callBacks.onDomainsToggle()}),!1),document.getElementById("button-paint-domains-square").addEventListener("click",(function(){e.callBacks.onDomainsSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-support-square-domain").addEventListener("click",(function(){e.callBacks.onShowSquareDomainSupport(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-domain-attack-square").addEventListener("click",(function(){e.callBacks.onDomainAttacksSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-domain-danger-square").addEventListener("click",(function(){e.callBacks.onDomainDangerSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-attack-square").addEventListener("click",(function(){e.callBacks.onShowAttackSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-danger-square").addEventListener("click",(function(){e.callBacks.onDangerSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-board-flip").addEventListener("click",(function(){e.callBacks.onFlip(e.buffer.squareTarget)}),!1),document.getElementById("button-paint-support-square").addEventListener("click",(function(){e.callBacks.onShowSquareSupport(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-visuals-remove").addEventListener("click",(function(){e.callBacks.onRemoveVisuals()}),!1),document.getElementById("button-markers-toggle").addEventListener("click",(function(){e.callBacks.onToggleMarkers()}),!1),document.getElementById("button-fen-create-board").addEventListener("click",(function(){e.callBacks.onLoadFenFromInput()}),!1),document.getElementById("button-fen-create-fen").addEventListener("click",(function(){e.callBacks.onLoadFenToInput()}),!1),document.getElementById("button-fen-create-link").addEventListener("click",(function(){e.callBacks.onCreateLink()}),!1),document.getElementById("button-nav-prev").addEventListener("click",(function(){e.callBacks.onNavPrev()}),!1),document.getElementById("button-nav-next").addEventListener("click",(function(){e.callBacks.onNavNext()}),!1),document.getElementById("button-nav-record").addEventListener("click",(function(){e.callBacks.onNavRecord()}),!1),document.getElementById("button-pgn-import").addEventListener("click",(function(){e.callBacks.onLoadPgn()}),!1),document.getElementById("button-paint-report-balance-whites").addEventListener("click",(function(){e.callBacks.onDisplayReportBalanceWhites()}),!1),document.getElementById("button-paint-report-balance-blacks").addEventListener("click",(function(){e.callBacks.onDisplayReportBalanceBlacks()}),!1)}async setBufferSquareTarget(e){if(this.buffer.squareTarget=e,e){const t=document.getElementById(`base-${e}`);t.classList.contains("with-selection")?t.classList.remove("with-selection"):t.classList.add("with-selection")}}clearSelectedSquareFromBuffer(){const e=this.buffer.squareTarget;if(e){const t=document.getElementById(`base-${e}`);t.classList.contains("with-selection")&&t.classList.remove("with-selection"),this.buffer.squareTarget=null}}clearBufferAndSelection(){this.buffer.squareTarget=null,document.querySelectorAll(".base").forEach((e=>{e.classList.remove("with-selection")}))}}const c=function(e,t){return`${e}${t}`},l=function(e,t=white){return e?{letter:e,color:t}:null},u={convertFenStrToObject:function(e){const t={},a=["r","n","b","k","q","p","R","N","B","K","Q","P"];return e.split(" ")[0].split("/").forEach(((e,o)=>{const s=8-o;let n=1;e.split("").forEach((e=>{if(a.includes(e)){const a=r[n-1],o=c(a,s),i=e==e.toUpperCase(),u=e.toLowerCase();t[o]=l(u,i),n+=1}else{const a=parseInt(e,10);for(let e=n;e<a+n;e++){const a=r[e-1],o=c(a,s);t[o]=null}n+=parseInt(e,10)}}))})),t},convertSquareMapToFenStr:function(e){const t=[8,7,6,5,4,3,2,1],r=["a","b","c","d","e","f","g","h"];let a="",o=0;return t.forEach(((s,n)=>{o=0,r.forEach((t=>{const r=c(t,s),n=e.get(r);if(n){0!==o&&(a+=o.toString(),o=0);const e=n.color?n.letter.toUpperCase():n.letter.toLowerCase();a+=e}else o+=1})),0!==o&&(a+=o.toString()),n<t.length-1&&(a+="/")})),`${a} w KQkq - 0 1`},fenToMap:function(e){if(!e||""===e)return;const t=this.convertFenStrToObject(e);return new Map(Object.entries(t))}};class d{constructor(e=null){this.moves=[],this.moveIdx=0,this.state={move:null},e&&"fen"in e&&e.fen?this.init(e.fen):this.createSquaresMap(t,r)}init(e=s){this.setFenToSquareMap(e),this.movesReset(),this.moveSave()}clear(){this.createSquaresMap(t,r),this.movesReset()}createSquaresMap(e,t){const r=[];e.forEach((e=>{t.forEach((t=>{const a=c(t,e);r.push([a,null])}))})),this._squaresMap=new Map(r)}getSquareMapAsFen(){return u.convertSquareMapToFenStr(this.getSquaresMap())}setFenToSquareMap(e){const t=u.fenToMap(e);this.setSquaresMap(t)}getSquaresMap(){return this._squaresMap}setSquaresMap(e){this._squaresMap=e}setMoveState(e,t){this.state.move={from:e,to:t}}setFigureInSquare(e,t,r=!0){this._squaresMap.set(e,l(t,r))}async move(e,t){const r=this._squaresMap.get(e);if(r)return this.setFigureInSquare(t,r.letter,r.color),this.setFigureInSquare(e,null),this.setMoveState(e,t),!0}movesReset(){this.moveIdx=0,this.moves.length=this.moveIdx,this.state={move:null}}moveSave(){const e={from:this.state.move?this.state.move.from:null,to:this.state.move?this.state.move.to:null,fen:this.getSquareMapAsFen()},t=this.moveIdx;0!==this.moves.length&&(this.moves.length=t+1),this.moves.push(e),this.moveIdx=this.moves.length-1}get currentMoveIdx(){return this.moveIdx}get currentMove(){return this.moves[this.moveIdx]}moveNext(){let e=this.moveIdx+1;e>=this.moves.length&&(e=this.moves.length-1),this.moveIdx=e;const t=this.moves[e];t&&this.setFenToSquareMap(t.fen)}movePrev(){let e=this.moveIdx-1;e<=0&&(e=0),this.moveIdx=e;const t=this.moves[e];t&&this.setFenToSquareMap(t.fen)}getMoveByIdx(e){return e<this.moves.length?this.moves[this.moveIdx]:null}}const h=function(e,t,r,a,o){const s=c(e,r),n=o.asIcon,i=o.svg.div,l=i*t,u=i*a;let d=6.75;n&&(d=9);const h=`\n      <title>${s}</title>\n      <rect id="base-${s}" \n          data-square="${s}"\n          class="base" \n          width="${i}%" \n          height="${i}%"  />\n      <g id="markers-${s}" \n          data-square="${s}"\n          class="markers" \n          width="${i}%" \n          height="${i}%"  \n          fill="transparent"\n          />\n      <text id="piece-${s}" \n          data-square="${s}"\n          class="piece ${n?"asIcon":""}" \n          text-anchor="middle" \n          x="0" \n          y="0" \n          dy="${n?i/1.2:i/1.5}"\n          dx="${i/2}"\n          font-size="${d}"\n       ></text>\n  `,m=document.createElementNS("http://www.w3.org/2000/svg","g");return m.setAttribute("class","square"),m.setAttribute("id",`${s}`),m.setAttribute("data-square",`${s}`),m.setAttribute("data-square-col",`${e}`),m.setAttribute("data-square-row",`${r}`),m.setAttribute("transform",`translate(${l},${u})`),m.innerHTML=h,m},m=function(e,t="",r=!0){const a=document.getElementById(`piece-${e}`),o=r?"white":"black";a.classList.add(o);const s=r?"black":"white";r&&a.classList.contains(s)&&a.classList.remove(s),a.textContent=t},f=function(e){const t={};let r=document.createElement("a");r.href=e;const a=r.search.substring(1);if(!a)return t;const o=a.split("&");for(let e=0;e<o.length;e++){const r=o[e].split("=");t[r[0]]=decodeURIComponent(r[1])}return t},S=function(e){const t=e?`?fen=${e}`:"";return`${window.location.origin}${window.location.pathname}${t}`};class g{constructor(e,t){this.config={flip:e.flip,asIcon:e.asIcon,svg:{div:90/8}},this.boardService=t.boardService}changeHistoryWithFen(e){const t=S(e);history.pushState({id:"game-render"},"",t)}getRows(){return this.config.flip?[...t].reverse():t}getCols(){return this.config.flip?[...r].reverse():r}async drawBoardFromSquareMap(){this.drawCoordinates(),this.drawSquares(),this.drawPiecesFromMap()}async drawBoardFlipped(){const e=document.querySelectorAll(".square"),t=document.querySelectorAll(".board-coordinate");e.forEach((e=>{e.remove()})),t.forEach((e=>{e.remove()})),this.config.flip=!this.config.flip,this.drawBoardFromSquareMap()}drawSquares(){const e=this.getRows(),t=this.getCols(),r=document.getElementById("svg-squares");e.forEach(((e,a)=>{t.forEach(((t,o)=>{const s=h(t,o,e,a,this.config);r.appendChild(s)}))}))}drawCoordinates(){const e=this.getRows(),t=this.getCols(),r=document.getElementById("svg-coordinates");t.forEach(((e,t)=>{const a=document.createElementNS("http://www.w3.org/2000/svg","text"),o=document.createTextNode(e);a.setAttribute("x",this.config.svg.div*t+"%"),a.setAttribute("y","0"),a.setAttribute("dy","0"),a.setAttribute("dx","1"),a.setAttribute("data-coord-col",`${e}`),a.setAttribute("class","board-coordinate board-coordinate-col"),a.setAttribute("text-anchor","start"),a.appendChild(o),r.appendChild(a)})),e.forEach(((e,t)=>{const a=document.createElementNS("http://www.w3.org/2000/svg","text"),o=document.createTextNode(e);a.setAttribute("x","0"),a.setAttribute("y",this.config.svg.div*t+"%"),a.setAttribute("dy","6"),a.setAttribute("dx","-3"),a.setAttribute("data-coord-row",`${e}`),a.setAttribute("class","board-coordinate board-coordinate-row"),a.setAttribute("text-anchor","start"),a.appendChild(o),r.appendChild(a)}))}drawPiecesFromMap(){this.boardService.getSquaresMap().forEach(((e,t)=>{if(e){let r="";const a=n[e.letter];r=!0===this.config.asIcon?a.asIcon(e.color):a.asLetter(e.color),m(t,r,e.color)}else m(t)}));const e=this.boardService.getSquareMapAsFen();this.changeHistoryWithFen(e)}}const p=function(e){let t;const r=/([0-9]{1,2}\.)\s?([\S]+) ([\S]+)/gm,a=[],o=e.replace(/(\[.+\])/g,"").replace(/(?:\r\n|\r|\n)/g," ");for(;null!==(t=r.exec(o));)t.index===r.lastIndex&&r.lastIndex++,t.forEach(((e,t)=>{2===t&&a.push(e),3===t&&a.push(e)}));return a},v=function(e,t=!0){const r=e.replace("#","").replace("+","").replace("?","").replace("!","");if(["1-0","1:0","0-1","0:1","1/2-1/2","*"].includes(r))return[];if("O-O"===r)return t===a?[{figure:"k",squareFrom:"e1",squareTo:"g1",color:t},{figure:"r",squareFrom:"h1",squareTo:"f1",color:t}]:[{figure:"k",squareFrom:"e8",squareTo:"g8",color:t},{figure:"r",squareFrom:"h8",squareTo:"f8",color:t}];if("O-O-O"===r)return t===a?[{figure:"k",squareFrom:"e1",squareTo:"c1",color:t},{figure:"r",squareFrom:"a1",squareTo:"d1",color:t}]:[{figure:"k",squareFrom:"e8",squareTo:"c8",color:t},{figure:"r",squareFrom:"a8",squareTo:"d8",color:t}];if(r.indexOf("=")>-1){const e=r.split("=");return[{figure:"p",figureToChange:e[1].toLowerCase(),squareTo:e[0],color:t}]}try{const e=/([a-z]{1}[0-9]{1})/g.exec(r)[1],a=r.replace(e,"");let o=!1;if(a.includes("x")&&(o=!0),a===a.toLowerCase())return[{figure:"p",squareFrom:a.replace("x",""),squareTo:e,color:t,capture:o}];let s="",n="";return a.length>=2?(s=a[1].replace("x",""),n=a[0].toLowerCase()):n=a.toLowerCase(),[{figure:n,squareFrom:s,squareTo:e,color:t,capture:o}]}catch(t){throw new Error(`${t} >> ${e} ${r}`)}},q=function(e){try{let t=document.createElement("input");t.type="text",t.value=e,document.body.appendChild(t),t.select(),document.execCommand("Copy"),document.body.removeChild(t)}catch(e){console.error("[Clipboard] addTextToClipboard:",e)}};class b{constructor(e,t){this.config=e,this.boardService=t.boardService,this.analysisService=t.analysisService}createBoardLink(){const e=this.boardService.getSquareMapAsFen(),t=S(e);q(t)}loadFenFromInput(){const e=document.getElementById("fen-input").value;e&&this.boardService.setFenToSquareMap(e)}loadFenToInput(){const e=this.boardService.getSquareMapAsFen();document.getElementById("fen-input").value=e}loadPgnFromInput(){const e=document.getElementById("pgn-input").value;this.renderPgnToBoard(e)}renderPgnToBoard(e){const t=p(e),r=this.boardService.getSquaresMap();let o=a;const s=[];try{t.forEach((e=>{const t=v(e,o);o=!o,s.push(t)})),s.forEach((e=>{e.forEach((e=>{const{figure:t,figureToChange:a,squareFrom:o,squareTo:s,color:n,capture:i}=e;let c=!1;r.forEach(((e,r)=>{if(c||o!==r){if(!c&&e&&e.color===n&&e.letter===t&&this.analysisService.getSquarePieceAllowedSquares(r,null,!0).includes(s)){if(o&&!r.includes(o))return;if("p"===t){const e=r.split("")[0],t=s.split("")[0];if(!i&&e!==t)return}const e=a||t;this.boardService.setFigureInSquare(s,e,n),this.boardService.setFigureInSquare(r,null),this.boardService.setMoveState(r,s),this.boardService.moveSave(),c=!0}}else this.boardService.setFigureInSquare(s,t,n),this.boardService.setFigureInSquare(o,null),this.boardService.setMoveState(o,s),this.boardService.moveSave(),c=!0}))}))}))}catch(e){console.error("[PGN PARSER] error",e)}}}function k(e,t=!0){let r=t?"ok":"error";const a=document.getElementById(`markers-${e}`),o=document.createElementNS("http://www.w3.org/2000/svg","use");o.setAttribute("href",`#marker-rect-${r}`),o.setAttribute("data-square",`${e}`),a.appendChild(o)}function w(e,t=null){let r="neutral";t===a?r="white":!1===t&&(r="black");const o=document.getElementById(`markers-${e}`),s=document.createElementNS("http://www.w3.org/2000/svg","use");s.setAttribute("href",`#marker-circle-${r}`),s.setAttribute("data-square",`${e}`),o.appendChild(s)}function B(e){const t=document.getElementById(`markers-${e}`),r=document.createElementNS("http://www.w3.org/2000/svg","use");r.setAttribute("href","#marker-move-last"),r.setAttribute("data-square",`${e}`),t.appendChild(r)}const E=function(e,t,r,a=!0){let o="default";return 0===t&&e>0&&r&&r.color!==a&&(o="advice"),e>t&&r&&r.color!==a&&(o="advice"),(t>0&&0===e||t>e)&&(o="alert"),0!==t||0!==e||r||(o="neutral"),t===e&&r&&r.color===a&&(o="alert"),e>t&&(r&&r.color===a||!r)&&(o="ok"),o},y=function(){const e=document.querySelectorAll(".markers"),t="marker-invisible";e.forEach((e=>{e.classList.contains(t)?e.classList.remove(t):e.classList.add(t)}))},M=function(e){return e?"marker-circle-white":"marker-circle-black"},I=function(e){return e?"with-domain-white":"with-domain-black"},T=function(e,t,r="default"){const a=document.createElementNS("http://www.w3.org/2000/svg","text"),o=document.createTextNode(t);a.setAttribute("x","11.25%"),a.setAttribute("y","0"),a.setAttribute("dx","-0.5"),a.setAttribute("dy","3"),a.setAttribute("data-square",`${e}`),a.setAttribute("class",`marker-square-notation ${r}`),a.setAttribute("text-anchor","end"),a.appendChild(o),document.getElementById(`markers-${e}`).appendChild(a)},F=function(e,t){switch(t){case"marker-circle-white":w(e,!0);break;case"marker-circle-neutral":w(e);break;case"marker-circle-black":w(e,!1);break;case"marker-move-last":B(e);break;case"marker-rect-ok":k(e,!0);break;case"marker-rect-error":k(e,!1)}},A=function(e){const t=document.getElementById(`markers-${e}`).children;for(var r=t.length-1;r>=0;--r)t[r].remove()},D=function(){const e=[];return t.forEach((t=>{r.forEach((r=>{const a=c(r,t);e.push([a,[]])}))})),new Map(e)},L=function(){const e=document.querySelectorAll(".markers"),t="marker-invisible";e.forEach((e=>{e.classList.contains(t)&&e.classList.remove(t)}))},C=function(e,t,a,o=!1){const s=r.indexOf(t),n=[];for(let r=a-1;r>=1;r--){n.push(c(t,r));const a=n[n.length-1];if(e.get(a)&&o)break}for(let r=a+1;r<=8;r++){n.push(c(t,r));const a=n[n.length-1];if(e.get(a)&&o)break}for(let t=s+1;t<r.length;t++){n.push(c(r[t],a));const s=n[n.length-1];if(e.get(s)&&o)break}for(let t=s-1;t>=0;t--){n.push(c(r[t],a));const s=n[n.length-1];if(e.get(s)&&o)break}return n},x=function(e,t){const a=r.indexOf(e),o=[];return[[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]].forEach((e=>{const s=t+e[0],n=a+e[1];n>=0&&n<r.length&&s>0&&s<=8&&o.push(c(r[n],s))})),o},$=function(e,t,a,o){const s=r.indexOf(e),n=[],i=a?t+1:t-1,l=[[1,i],[-1,i]];if(o){l.push([0,i]);const e=a?t+2:t-2;l.push([0,e])}return l.forEach((e=>{const t=s+e[0],a=e[1];t>=0&&t<r.length&&a>0&&a<=8&&n.push(c(r[t],a))})),n},P=function(e,t,a,o=!1){const s=r.indexOf(t),n=[];let i=1;for(let t=a-1;t>=0;t--){const a=s+i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(c(r[a],t)),i++;const s=n[n.length-1];if(e.get(s)&&o)break}}i=1;for(let t=a-1;t>=0;t--){const a=s-i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(c(r[a],t)),i++;const s=n[n.length-1];if(e.get(s)&&o)break}}i=1;for(let t=a+1;t<=8;t++){const a=s-i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(c(r[a],t)),i++;const s=n[n.length-1];if(e.get(s)&&o)break}}i=1;for(let t=a+1;t<=8;t++){const a=s+i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(c(r[a],t)),i++;const s=n[n.length-1];if(e.get(s)&&o)break}}return n},R=function(e,t){const a=r.indexOf(e),o=[];return[[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1]].forEach((e=>{const s=a+e[0],n=t+e[1];s>=0&&s<r.length&&n>0&&n<=8&&o.push(c(r[s],n))})),o};class W{constructor(e,t){this.markersMap=D(),this.boardService=t.boardService,this.config=e,this.state={isDomainWhiteOn:!1,isDomainBlackOn:!1}}toggleMarkers(){y()}toggleColorDomain(e=!0){(e?this.state.isDomainWhiteOn:this.state.isDomainBlackOn)?this.drawClearDomains(e):this.drawDomainByColor(e)}toggleDomains(){this.state.isDomainWhiteOn||this.state.isDomainBlackOn?(this.drawClearDomains(a),this.drawClearDomains(o)):(this.drawDomainByColor(a),this.drawDomainByColor(o))}drawDomainsByState(){this.state.isDomainWhiteOn&&this.drawDomainByColor(a),this.state.isDomainBlackOn&&this.drawDomainByColor(o)}addMarkerToSquare(e,t,r=!1){if(!e)return;L();const a=this.markersMap.get(e),o=a.indexOf(t);-1===o&&(a.push(t),this.markersMap.set(e,a),F(e,t)),r&&o>-1&&(a.splice(o,1),this.markersMap.set(e,a),this.drawMarkersFromMapBySquareName(e))}drawMarkersFromMap(){L(),this.markersMap.forEach(((e,t)=>{A(t),e.forEach((e=>{AnalysisServiceUtils.drawMarkerInSquare(t,e)}))}))}drawMarkersFromMapBySquareName(e){L(),A(e),this.markersMap.get(e).forEach((t=>{F(e,t)}))}drawRemoveAllMarkers(){this.markersMap=D(),this.drawMarkersFromMap()}getSquarePieceAllowedSquares(e,t=null,r=!1){const a=this.boardService.getSquaresMap(),o=this.config.withLimitation,s=[];if(!e)return;const n=e.split(""),i=n[0],c=parseInt(n[1],10),{letter:l,color:u}=t||a.get(e);if("r"===l){const e=C(a,i,c,o);s.push(...e)}if("n"===l){const e=x(i,c);s.push(...e)}if("p"===l){const e=$(i,c,u,r);s.push(...e)}if("b"===l){const e=P(a,i,c,o);s.push(...e)}if("q"===l){const e=C(a,i,c,o),t=P(a,i,c,o);s.push(...e,...t)}if("k"===l){const e=R(i,c);s.push(...e)}return s}boardSquareDangerSupportRepor(e=!0){L(),this.drawRemoveAllMarkers();const t=this.boardService.getSquaresMap();t.forEach(((r,a)=>{let o=0,s=0,n="";t.forEach(((t,i)=>{const c=t;c&&this.getSquarePieceAllowedSquares(i).includes(a)&&(r&&t&&r.color===t.color?(o+=1,"k"===t.letter&&(n="#")):r&&t&&r.color!==t.color?s+=1:r||(c.color===e?o+=1:s+=1))}));const i=E(o,s,r,e);T(a,`${n}${o}-${s}`,i)}))}drawSupportToSquare(e){if(!e)return;L();const t=this.boardService.getSquaresMap();let r=!1;const a=t.get(e);a&&(t.forEach(((t,o)=>{if(o!==e&&t&&t.color===a.color&&this.getSquarePieceAllowedSquares(o).includes(e)){r=!0;const e=M(t.color);this.addMarkerToSquare(o,e),this.drawDomainBySquare(o)}})),r?this.addMarkerToSquare(e,"marker-rect-ok"):this.addMarkerToSquare(e,"marker-rect-error"))}drawDangerToSquareDomain(e){if(!e)return;L();const t=this.boardService.getSquaresMap();let r=!0;const a=t.get(e);if(a){const o=this.getSquarePieceAllowedSquares(e);o.forEach((()=>{this.drawDomainBySquare(e),t.forEach(((t,s)=>{if(s!==e&&t&&t.color!==a.color){const e=this.getSquarePieceAllowedSquares(s),a=o.filter((t=>e.includes(t)));a.forEach((e=>{const r=M(t.color);this.addMarkerToSquare(s,r),this.addMarkerToSquare(e,r)})),a.length>0&&(r=!1)}}))})),r?this.addMarkerToSquare(e,"marker-rect-ok"):this.addMarkerToSquare(e,"marker-circle-neutral")}}drawDangerToSquare(e){if(!e)return;L();const t=this.boardService.getSquaresMap();let r=!0;const a=t.get(e);if(a)if(t.forEach(((t,o)=>{if(o!==e&&t&&t.color!==a.color&&this.getSquarePieceAllowedSquares(o).includes(e)){r=!1;const e=M(t.color);this.addMarkerToSquare(o,e),this.drawDomainBySquare(o)}})),r)this.addMarkerToSquare(e,"marker-rect-ok");else{const t=M(a.color);this.addMarkerToSquare(e,t)}}drawAttackFromSquareDomain(e){if(!e)return;L();const t=this.boardService.getSquaresMap(),r=t.get(e);if(r){const a=M(r.color),o=this.getSquarePieceAllowedSquares(e);this.drawDomainBySquare(e),o.forEach((o=>{const s=r;this.getSquarePieceAllowedSquares(o,s).forEach((s=>{const n=t.get(s);n&&n.color!==r.color&&(this.addMarkerToSquare(e,"marker-circle-neutral"),this.addMarkerToSquare(o,a),this.addMarkerToSquare(s,a))}))}))}}drawSupportToSquareDomain(e){if(!e)return;L();const t=this.boardService.getSquaresMap();let r=!1;const a=t.get(e);if(a){this.drawDomainBySquare(e);const o=this.getSquarePieceAllowedSquares(e);o.forEach((s=>{t.forEach(((t,s)=>{if(s!==e&&t&&t.color===a.color){const e=this.getSquarePieceAllowedSquares(s),a=o.filter((t=>e.includes(t)));a.forEach((e=>{const r=M(t.color);this.addMarkerToSquare(s,r),this.addMarkerToSquare(e,r)})),a.length>0&&(r=!0)}}))})),r?this.addMarkerToSquare(e,"marker-circle-neutral"):this.addMarkerToSquare(e,"marker-rect-error")}}drawDomainByColor(e=!0){const t=this.boardService.getSquaresMap();this.drawClearDomains(e),e?this.state.isDomainWhiteOn=!0:this.state.isDomainBlackOn=!0;const r=I(e),a=[];return t.forEach(((t,r)=>{if(t&&t.color===e){const e=this.getSquarePieceAllowedSquares(r);a.push(...e)}})),a.forEach((e=>{document.getElementById(`base-${e}`).classList.add(r)})),a}drawDomainBySquare(e){const t=this.boardService.getSquaresMap().get(e);if(t){const r=M(t.color);this.addMarkerToSquare(e,r),this.getSquarePieceAllowedSquares(e).forEach((e=>{const r=I(t.color);document.getElementById(`base-${e}`).classList.add(r)}))}}drawClearDomains(e=!0){const t=this.boardService.getSquaresMap();e?this.state.isDomainWhiteOn=!1:this.state.isDomainBlackOn=!1;const r=I(e);t.forEach(((e,t)=>{document.getElementById(`base-${t}`).classList.remove(r)}))}drawAttackFromSquare(e){if(!e)return;L();const t=this.boardService.getSquaresMap(),r=t.get(e);if(r){const a=this.getSquarePieceAllowedSquares(e),o=M(r.color);a.forEach((e=>{const a=t.get(e);a&&a.color!==r.color&&this.addMarkerToSquare(e,o)}))}}}const O=f(window.location.href);let N=null;"fen"in O&&(N=O.fen);const K={fen:N,asIcon:!0,withLimitation:!0,flip:!1};new class{constructor(e){this.config=this.parseConfig(e),this.boardService=new d(this.config.board),this.boardRenderService=new g(this.config.render,{boardService:this.boardService}),this.analysisService=new W(this.config.analysis,{boardService:this.boardService}),this.gameExportService=new b(null,{boardService:this.boardService,analysisService:this.analysisService}),this.controlsService=new i(this.actionsBridge),this.boardRenderService.drawBoardFromSquareMap().then((()=>{this.controlsService.squareControls(),this.lab()}))}lab(){}parseConfig(e){return{analysis:{withLimitation:"withLimitation"in e&&e.withLimitation},board:{fen:"fen"in e?e.fen:s},render:{flip:"flip"in e&&e.flip,asIcon:!("asIcon"in e)||e.asIcon,asLines:!("asLines"in e)||e.asLines}}}async chessMove(e,t){await this.boardService.move(e,t),this.boardRenderService.drawPiecesFromMap(),this.analysisService.drawDomainsByState()}chessAddPiece(e,t,r){e&&(this.boardService.setFigureInSquare(e,t,r),this.boardRenderService.drawPiecesFromMap())}chessClearBoard(){this.boardService.clear(),this.boardRenderService.drawPiecesFromMap()}chessInitBoard(){this.boardService.init(),this.boardRenderService.drawPiecesFromMap()}get actionsBridge(){return{movePiecesFromSquares:(e,t)=>this.chessMove(e,t),onFlip:async()=>{await this.boardRenderService.drawBoardFlipped(),this.controlsService.squareControls(),this.lab()},onAdd:(e,t,r)=>this.chessAddPiece(e,t,r),onClearSquare:e=>this.chessAddPiece(e,null),onClear:()=>this.chessClearBoard(),onInit:()=>this.chessInitBoard(),onDisplayReportBalanceWhites:()=>{this.analysisService.boardSquareDangerSupportRepor(a)},onDisplayReportBalanceBlacks:()=>{this.analysisService.boardSquareDangerSupportRepor(o)},onShowSquareSupport:e=>{this.analysisService.drawSupportToSquare(e)},onShowSquareDomainSupport:e=>{this.analysisService.drawSupportToSquareDomain(e)},onDomainW:async()=>{await this.analysisService.toggleColorDomain(a)},onDomainB:async()=>{await this.analysisService.toggleColorDomain(o)},onDomainsToggle:async()=>{await this.analysisService.toggleDomains()},onDomainsSquare:async e=>{this.analysisService.drawDomainBySquare(e)},onDomainDangerSquare:e=>{this.analysisService.drawDangerToSquareDomain(e)},onDomainAttacksSquare:async e=>{this.analysisService.drawAttackFromSquareDomain(e)},onShowAttackSquare:async e=>{this.analysisService.drawAttackFromSquare(e)},onDangerSquare:async e=>{this.analysisService.drawDangerToSquare(e)},onRemoveVisuals:()=>{this.analysisService.drawRemoveAllMarkers(),this.analysisService.drawClearDomains(a),this.analysisService.drawClearDomains(o)},onAddMarker:(e,t)=>{this.analysisService.addMarkerToSquare(e,t,!0)},onToggleMarkers:()=>{this.analysisService.toggleMarkers()},onLoadFenFromInput:()=>{this.gameExportService.loadFenFromInput(),this.boardRenderService.drawPiecesFromMap()},onLoadFenToInput:()=>{this.gameExportService.loadFenToInput()},onCreateLink:()=>{this.gameExportService.createBoardLink()},onLoadPgn:()=>{this.gameExportService.loadPgnFromInput(),this.boardRenderService.drawPiecesFromMap()},onNavRecord:()=>{this.boardService.moveSave()},onNavPrev:()=>{this.boardService.movePrev(),this.boardRenderService.drawPiecesFromMap(),this.analysisService.drawDomainsByState()},onNavNext:()=>{this.boardService.moveNext(),this.boardRenderService.drawPiecesFromMap(),this.analysisService.drawDomainsByState()}}}}(K)})();
//# sourceMappingURL=main.03f53b5deb44a1c1ea05.js.map