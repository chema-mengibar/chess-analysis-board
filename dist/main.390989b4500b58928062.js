(()=>{"use strict";class e{constructor(e){this.letterW=e.letterW,this.iconW=e.iconW,this.letterB=e.letterB,this.iconB=e.iconB}asLetter(e=!0){return e?this.letterW:this.letterB}asIcon(e=!0){return e?this.iconW:this.iconB}}const t=[8,7,6,5,4,3,2,1],r=["a","b","c","d","e","f","g","h"],a="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",s=["c","d","e","f"],o=!0,n=!1,i={b:new e({letterW:"B",iconW:"♗",letterB:"b",iconB:"♝"}),r:new e({letterW:"R",iconW:"♖",letterB:"r",iconB:"♜"}),n:new e({letterW:"N",iconW:"♘",letterB:"n",iconB:"♞"}),k:new e({letterW:"K",iconW:"♔",letterB:"k",iconB:"♚"}),q:new e({letterW:"Q",iconW:"♕",letterB:"q",iconB:"♛"}),p:new e({letterW:"P",iconW:"♙",letterB:"p",iconB:"♟"})};function c(e){return`${window.location.origin}${window.location.pathname}?fen=${e}`}function u(e,t){return`${e}${t}`}function l(e,t=!0){return e?{letter:e,color:t}:null}const d={getCellKey:u,createSquaresMap:function(e,t){const r=[];return e.forEach((e=>{t.forEach((t=>{const a=u(t,e);r.push([a,null])}))})),new Map(r)},createMarkersMap:function(e,t){const r=[];return e.forEach((e=>{t.forEach((t=>{const a=u(t,e);r.push([a,[]])}))})),new Map(r)},parseFenStrToObject:function(e){const t={},a=["r","n","b","k","q","p","R","N","B","K","Q","P"];return e.split(" ")[0].split("/").forEach(((e,s)=>{const o=8-s;let n=1;e.split("").forEach((e=>{if(a.includes(e)){const a=u(r[n-1],o),s=e==e.toUpperCase(),i=e.toLowerCase();t[a]=l(i,s),n+=1}else{const a=parseInt(e,10);for(let e=n;e<a+n;e++){const a=u(r[e-1],o);t[a]=null}n+=parseInt(e,10)}}))})),t},parseMapToFenStr:function(e){const t=[8,7,6,5,4,3,2,1],r=["a","b","c","d","e","f","g","h"];let a="",s=0;return t.forEach(((o,n)=>{s=0,r.forEach((t=>{const r=u(t,o),n=e.get(r);if(n){0!==s&&(a+=s.toString(),s=0);const e=n.color?n.letter.toUpperCase():n.letter.toLowerCase();a+=e}else s+=1})),0!==s&&(a+=s.toString()),n<t.length-1&&(a+="/")})),`${a} w KQkq - 0 1`},asSquare:l,parseConfig:function(e){return{flip:"flip"in e&&e.flip,asIcon:!("asIcon"in e)||e.asIcon,asLines:!("asLines"in e)||e.asLines,withLimitation:"withLimitation"in e&&e.withLimitation}},getAbsoluteRouteWithFen:c,changeHistoryWithFen:function(e){const t=c(e);history.pushState({id:"game-move"},"",t)},parsePgn:function(e){let t;const r=/([0-9]{1,2}.)\s?([\S]+) ([\S]+)/gm,a=[],s=e.replace(/(\[.+\])/g,"").replace(/(?:\r\n|\r|\n)/g," ");for(;null!==(t=r.exec(s));)t.index===r.lastIndex&&r.lastIndex++,t.forEach(((e,t)=>{2===t&&a.push(e),3===t&&a.push(e)}));return a},parsePgnNotation:function(e,t=!0){const r=e.replace("#","").replace("+","").replace("?","").replace("!","");if(["1-0","1:0","0-1","0:1","1/2-1/2","*"].includes(r))return[];if("O-O"===r)return t===o?[{figure:"k",squareFrom:"e1",squareTo:"g1",color:t},{figure:"r",squareFrom:"h1",squareTo:"f1",color:t}]:[{figure:"k",squareFrom:"e8",squareTo:"g8",color:t},{figure:"r",squareFrom:"h8",squareTo:"f8",color:t}];if("O-O-O"===r)return t===o?[{figure:"k",squareFrom:"e1",squareTo:"c1",color:t},{figure:"r",squareFrom:"a1",squareTo:"d1",color:t}]:[{figure:"k",squareFrom:"e8",squareTo:"c8",color:t},{figure:"r",squareFrom:"a8",squareTo:"d8",color:t}];if(r.indexOf("=")>-1){const e=r.split("=");return[{figure:e[1].toLowerCase(),squareTo:e[0],color:t}]}const a=/([a-z]{1}[0-9]{1})/g.exec(r)[1],s=r.replace(a,"");let n=!1;if(s.includes("x")&&(n=!0),s===s.toLowerCase())return[{figure:"p",squareFrom:s,squareTo:a,color:t,eat:n}];let i="",c="";return 2===s.length?(i=s[1],c=s[0].toLowerCase()):c=s.toLowerCase(),[{figure:c,squareFrom:i,squareTo:a,color:t,eat:n}]}};class h{constructor(){this.moves=[],this.moveIdx=0}reset(){this.moveIdx=0,this.moves.length=this.moveIdx}saveMove(e,t,r){const a={from:e,to:t,fen:d.parseMapToFenStr(r)},s=this.moveIdx;0!==this.moves.length&&(this.moves.length=s+1),this.moves.push(a),this.moveIdx=this.moves.length-1}get currentMoveIdx(){return this.moveIdx}get currentMove(){return this.moves[this.moveIdx]}get prevMove(){let e=this.moveIdx-1;return e<=0&&(e=0),this.moveIdx=e,this.moves[e]}get nextMove(){let e=this.moveIdx+1;return e>=this.moves.length&&(e=this.moves.length-1),this.moveIdx=e,this.moves[e]}getMoveByIdx(e){return e<this.moves.length?this.moves[this.moveIdx]:null}}const m=function(e,t,a,s=!1){const o=r.indexOf(t),n=[];for(let r=a-1;r>=1;r--){n.push(d.getCellKey(t,r));const a=n[n.length-1];if(e.get(a)&&s)break}for(let r=a+1;r<=8;r++){n.push(d.getCellKey(t,r));const a=n[n.length-1];if(e.get(a)&&s)break}for(let t=o+1;t<r.length;t++){n.push(d.getCellKey(r[t],a));const o=n[n.length-1];if(e.get(o)&&s)break}for(let t=o-1;t>=0;t--){n.push(d.getCellKey(r[t],a));const o=n[n.length-1];if(e.get(o)&&s)break}return n},f=function(e,t){const a=r.indexOf(e),s=[];return[[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]].forEach((e=>{const o=t+e[0],n=a+e[1];n>=0&&n<r.length&&o>0&&o<=8&&s.push(d.getCellKey(r[n],o))})),s},g=function(e,t,a,s){const o=r.indexOf(e),n=[],i=a?t+1:t-1,c=[[1,i],[-1,i]];if(s){c.push([0,i]);const e=a?t+2:t-2;c.push([0,e])}return c.forEach((e=>{const t=o+e[0],a=e[1];t>=0&&t<r.length&&a>0&&a<=8&&n.push(d.getCellKey(r[t],a))})),n},p=function(e,t,a,s=!1){const o=r.indexOf(t),n=[];let i=1;for(let t=a-1;t>=0;t--){const a=o+i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(d.getCellKey(r[a],t)),i++;const o=n[n.length-1];if(e.get(o)&&s)break}}i=1;for(let t=a-1;t>=0;t--){const a=o-i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(d.getCellKey(r[a],t)),i++;const o=n[n.length-1];if(e.get(o)&&s)break}}i=1;for(let t=a+1;t<=8;t++){const a=o-i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(d.getCellKey(r[a],t)),i++;const o=n[n.length-1];if(e.get(o)&&s)break}}i=1;for(let t=a+1;t<=8;t++){const a=o+i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(d.getCellKey(r[a],t)),i++;const o=n[n.length-1];if(e.get(o)&&s)break}}return n},q=function(e,t){const a=r.indexOf(e),s=[];return[[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1]].forEach((e=>{const o=a+e[0],n=t+e[1];o>=0&&o<r.length&&n>0&&n<=8&&s.push(d.getCellKey(r[o],n))})),s},k=90/8;function S(e,t=null){let r="neutral";t===o?r="white":!1===t&&(r="black");const a=document.getElementById(`markers-${e}`),s=document.createElementNS("http://www.w3.org/2000/svg","use");s.setAttribute("href",`#marker-circle-${r}`),s.setAttribute("data-square",`${e}`),a.appendChild(s)}function w(e,t=!0){let r=t?"ok":"error";const a=document.getElementById(`markers-${e}`),s=document.createElementNS("http://www.w3.org/2000/svg","use");s.setAttribute("href",`#marker-rect-${r}`),s.setAttribute("data-square",`${e}`),a.appendChild(s)}function B(e){const t=document.getElementById(`markers-${e}`),r=document.createElementNS("http://www.w3.org/2000/svg","use");r.setAttribute("href","#marker-move-last"),r.setAttribute("data-square",`${e}`),t.appendChild(r)}const v=function(e){return e?"with-domain-white":"with-domain-black"},M=function(e){return e?"marker-circle-white":"marker-circle-black"},b=function(e,t,r,a,s=!0){const o=d.getCellKey(e,r),n=k*t,i=k*a,c=`\n        <title>${o}</title>\n        <rect id="base-${o}" \n            data-square="${o}"\n            class="base" \n            width="11.25%" \n            height="11.25%"  />\n        <g id="markers-${o}" \n            data-square="${o}"\n            class="markers" \n            width="11.25%" \n            height="11.25%"  \n            fill="transparent"\n            />\n        <text id="piece-${o}" \n            data-square="${o}"\n            class="piece ${s?"asIcon":""}" \n            text-anchor="start" \n            x="${s?1.5:4}" \n            y="${s?-1.5:8}" \n            dy="${s?10:0}"\n         ></text>\n    `,u=document.createElementNS("http://www.w3.org/2000/svg","g");return u.setAttribute("class","square"),u.setAttribute("id",`${o}`),u.setAttribute("data-square",`${o}`),u.setAttribute("data-square-col",`${e}`),u.setAttribute("data-square-row",`${r}`),u.setAttribute("transform",`translate(${n},${i})`),u.innerHTML=c,u},E=function(e,t="",r=!0){const a=document.getElementById(`piece-${e}`),s=r?"white":"black";a.classList.add(s);const o=r?"black":"white";r&&a.classList.contains(o)&&a.classList.remove(o),a.textContent=t},y=function(e,t){const r=[];return t.forEach(((e,t)=>{const a=document.createElementNS("http://www.w3.org/2000/svg","text"),s=document.createTextNode(e);a.setAttribute("x",k*t+"%"),a.setAttribute("y","0"),a.setAttribute("dy","0"),a.setAttribute("dx","1"),a.setAttribute("data-coord-col",`${e}`),a.setAttribute("class","board-coordinate board-coordinate-col"),a.setAttribute("text-anchor","start"),a.appendChild(s),r.push(a)})),e.forEach(((e,t)=>{const a=document.createElementNS("http://www.w3.org/2000/svg","text"),s=document.createTextNode(e);a.setAttribute("x","0"),a.setAttribute("y",k*t+"%"),a.setAttribute("dy","6"),a.setAttribute("dx","-3"),a.setAttribute("data-coord-row",`${e}`),a.setAttribute("class","board-coordinate board-coordinate-row"),a.setAttribute("text-anchor","start"),a.appendChild(s),r.push(a)})),r},T=function(e){const t=document.getElementById(`markers-${e}`).children;for(var r=t.length-1;r>=0;--r)t[r].remove()},F=function(){const e=document.querySelectorAll(".markers"),t="marker-invisible";e.forEach((e=>{e.classList.contains(t)?e.classList.remove(t):e.classList.add(t)}))},I=function(e,t){switch(t){case"marker-circle-white":S(e,!0);break;case"marker-circle-neutral":S(e);break;case"marker-circle-black":S(e,!1);break;case"marker-move-last":B(e);break;case"marker-rect-ok":w(e,!0);break;case"marker-rect-error":w(e,!1)}},C=function(e){try{let t=document.createElement("input");t.type="text",t.value=e,document.body.appendChild(t),t.select(),document.execCommand("Copy"),document.body.removeChild(t)}catch(e){console.error("[Clipboard] addTextToClipboard:",e)}};class L{constructor(e){this.buffer={squareTarget:null},this.callBacks=e,this.panelControls()}squareControls(){const e=this;document.querySelectorAll(".square").forEach((t=>{t.addEventListener("click",(function(t){const r=(t.target||t.srcElement).getAttribute("data-square");e.checkOnSelectSquare(r)}),!1)}))}async checkOnSelectSquare(e){this.buffer.squareTarget?e===this.buffer.squareTarget||await this.callBacks.movePiecesFromSquares(this.buffer.squareTarget,e)?this.clearBufferAndSelection():(this.clearSelectedSquareFromBuffer(),this.setBufferSquareTarget(e)):this.setBufferSquareTarget(e)}panelControls(){const e=this;document.querySelectorAll(".button-add-fig").forEach((t=>{t.addEventListener("click",(function(t){const r=(t.target||t.srcElement).getAttribute("data-letter"),a=r===r.toUpperCase();e.callBacks.onAdd(e.buffer.squareTarget,r.toLowerCase(),a),e.clearSelectedSquareFromBuffer()}),!1)})),document.querySelectorAll(".button-marker").forEach((t=>{t.addEventListener("click",(function(t){const r=t.currentTarget.getAttribute("data-marker-id");e.callBacks.onAddMarker(e.buffer.squareTarget,r),e.clearSelectedSquareFromBuffer()}),!1)})),document.getElementById("button-clear-square").addEventListener("click",(function(){e.callBacks.onClearSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-domains-w").addEventListener("click",(function(){e.callBacks.onDomainW()}),!1),document.getElementById("button-paint-domains-b").addEventListener("click",(function(){e.callBacks.onDomainB()}),!1),document.getElementById("button-clear").addEventListener("click",(function(){e.callBacks.onClear()}),!1),document.getElementById("button-init").addEventListener("click",(function(){e.callBacks.onInit()}),!1),document.getElementById("button-toggle-domains").addEventListener("click",(function(){e.callBacks.onDomainsToggle()}),!1),document.getElementById("button-paint-domains-square").addEventListener("click",(function(){e.callBacks.onDomainsSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-support-square-domain").addEventListener("click",(function(){e.callBacks.onShowSquareDomainSupport(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-domain-attack-square").addEventListener("click",(function(){e.callBacks.onDomainAttacksSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-domain-danger-square").addEventListener("click",(function(){e.callBacks.onDomainDangerSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-attack-square").addEventListener("click",(function(){e.callBacks.onShowAttackSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-danger-square").addEventListener("click",(function(){e.callBacks.onDangerSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-board-flip").addEventListener("click",(function(){e.callBacks.onFlip(e.buffer.squareTarget)}),!1),document.getElementById("button-paint-support-square").addEventListener("click",(function(){e.callBacks.onShowSquareSupport(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-visuals-remove").addEventListener("click",(function(){e.callBacks.onRemoveVisuals()}),!1),document.getElementById("button-markers-toggle").addEventListener("click",(function(){e.callBacks.onToggleMarkers()}),!1),document.getElementById("button-fen-create-board").addEventListener("click",(function(){e.callBacks.onLoadFenFromInput()}),!1),document.getElementById("button-fen-create-fen").addEventListener("click",(function(){e.callBacks.onLoadFenToInput()}),!1),document.getElementById("button-fen-create-link").addEventListener("click",(function(){e.callBacks.onCreateLink()}),!1),document.getElementById("button-nav-prev").addEventListener("click",(function(){e.callBacks.onNavPrev()}),!1),document.getElementById("button-nav-next").addEventListener("click",(function(){e.callBacks.onNavNext()}),!1),document.getElementById("button-nav-record").addEventListener("click",(function(){e.callBacks.onNavRecord()}),!1),document.getElementById("button-pgn-import").addEventListener("click",(function(){e.callBacks.onLoadPgn()}),!1)}async setBufferSquareTarget(e){if(this.buffer.squareTarget=e,e){const t=document.getElementById(`base-${e}`);t.classList.contains("with-selection")?t.classList.remove("with-selection"):t.classList.add("with-selection")}}clearSelectedSquareFromBuffer(){const e=this.buffer.squareTarget;if(e){const t=document.getElementById(`base-${e}`);t.classList.contains("with-selection")&&t.classList.remove("with-selection"),this.buffer.squareTarget=null}}clearBufferAndSelection(){this.buffer.squareTarget=null,document.querySelectorAll(".base").forEach((e=>{e.classList.remove("with-selection")}))}}const A=function(e){const t={};let r=document.createElement("a");r.href=e;const a=r.search.substring(1);if(!a)return t;const s=a.split("&");for(let e=0;e<s.length;e++){const r=s[e].split("=");t[r[0]]=decodeURIComponent(r[1])}return t}(window.location.href);let D=null;"fen"in A&&(D=A.fen);const x={fen:D,asIcon:!0,asLines:!0,withLimitation:!0,flip:!1};new class{constructor(e){this.config=d.parseConfig(e),this.figures=i,this.colors={white:o,black:n},this.movesRegistry=new h,this.squaresMap=d.createSquaresMap(t,r),this.markersMap=d.createMarkersMap(t,r);const s=e.fen||a;this.fenToMap(s),this.render(),this.chessControls=new L(this.actionsBridge),this.state={isDomainWhiteOn:!1,isDomainBlackOn:!1,move:null},this.record()}lab(){}labMoves(){}fenToMap(e){if(!e||""===e)return;const t=d.parseFenStrToObject(e);this.squaresMap=new Map(Object.entries(t))}async render(){this.drawBoard().then((()=>{this.chessControls.squareControls(),this.lab()}))}flipBoard(){this.config.flip=!this.config.flip;const e=document.querySelectorAll(".square"),t=document.querySelectorAll(".board-coordinate");e.forEach((e=>{e.remove()})),t.forEach((e=>{e.remove()})),this.render()}async move(e,t){const r=this.squaresMap.get(e);if(r){this.setFigureInSquare(t,r.letter,r.color),this.setFigureInSquare(e,null),this.drawPiecesFromMap();const a=d.parseMapToFenStr(this.squaresMap);return d.changeHistoryWithFen(a),this.setMoveState(e,t),this.state.isDomainWhiteOn&&this.drawDomainByColor(o),this.state.isDomainBlackOn&&this.drawDomainByColor(n),!0}}setMoveState(e,t){this.state.move={from:e,to:t}}loadFenFromInput(){const e=document.getElementById("fen-input").value;this.fenToMap(e),d.changeHistoryWithFen(e),this.drawPiecesFromMap()}loadFenToInput(){const e=d.parseMapToFenStr(this.squaresMap);d.changeHistoryWithFen(e),document.getElementById("fen-input").value=e}loadPgnFromInput(){const e=document.getElementById("pgn-input").value;this.renderPgnToBoard(e)}renderPgnToBoard(e){const t=d.parsePgn(e);let r=o;const a=[];t.forEach((e=>{const t=d.parsePgnNotation(e,r);r=!r,a.push(t)})),a.forEach((e=>{e.forEach((e=>{const{figure:t,squareFrom:r,squareTo:a,color:s,eat:o}=e;let n=!1;this.squaresMap.forEach(((e,i)=>{if(n||r!==i){if(!n&&e&&e.color===s&&e.letter===t&&this.getSquarePieceAllowedSquares(i,null,!0).includes(a)){if("p"===t){const e=i.split("")[0],t=a.split("")[0];if(!o&&e!==t)return}this.setFigureInSquare(i,null),this.setFigureInSquare(a,t,s),this.setMoveState(i,a),this.record(),n=!0}}else this.setFigureInSquare(a,t,s),this.setFigureInSquare(r,null),this.setMoveState(r,a),this.record(),n=!0}))}))})),this.drawPiecesFromMap()}drawFromMove(e){this.fenToMap(e.fen),this.drawPiecesFromMap(),d.changeHistoryWithFen(e.fen),this.state.isDomainWhiteOn&&this.drawDomainByColor(o),this.state.isDomainBlackOn&&this.drawDomainByColor(n)}record(){const e=this.state.move?this.state.move.from:null,t=this.state.move?this.state.move.to:null;this.movesRegistry.saveMove(e,t,this.squaresMap)}setFigureInSquare(e,t,r=!0){this.squaresMap.set(e,d.asSquare(t,r))}addMarkerToSquare(e,t,r=!1){if(!e)return;const a=this.markersMap.get(e),s=a.indexOf(t);-1===s&&(a.push(t),this.markersMap.set(e,a),I(e,t)),r&&s>-1&&(a.splice(s,1),this.markersMap.set(e,a),this.drawMarkersFromMapBySquareName(e))}drawFlankCenterDomains(){const e=[6,5,4,3];s.forEach((t=>{e.forEach((e=>{const r=d.getCellKey(t,e);document.getElementById(`base-${r}`).classList.add("with-flank")}))}))}drawRemoveLastStepMoveMarker(){this.markersMap.forEach((e=>{const t=e.indexOf("marker-move-last");t>-1&&e.splice(t,1)})),this.drawMarkersFromMap()}async drawBoard(){const e=document.getElementById("svg-squares"),a=document.getElementById("svg-coordinates"),s=this.config.flip,o=s?[...t].reverse():t,n=s?[...r].reverse():r;o.forEach(((t,r)=>{n.forEach(((a,s)=>{const o=b(a,s,t,r,this.config.asIcon);e.appendChild(o)}))})),this.drawPiecesFromMap(),y(o,n).forEach((e=>{a.appendChild(e)}))}drawPiecesFromMap(){this.squaresMap.forEach(((e,t)=>{if(e){let r="";const a=i[e.letter];r=!0===this.config.asIcon?a.asIcon(e.color):a.asLetter(e.color),E(t,r,e.color)}else E(t)}))}drawMarkersFromMap(){this.markersMap.forEach(((e,t)=>{T(t),e.forEach((e=>{I(t,e)}))}))}drawMarkersFromMapBySquareName(e){T(e),this.markersMap.get(e).forEach((t=>{I(e,t)}))}drawRemoveAllMarkers(){this.markersMap=d.createMarkersMap(t,r),this.drawMarkersFromMap()}getSquarePieceAllowedSquares(e,t=null,r=!1){const a=this.config.withLimitation,s=[];if(!e)return;const o=e.split(""),n=o[0],i=parseInt(o[1],10),{letter:c,color:u}=t||this.squaresMap.get(e);if("r"===c){const e=m(this.squaresMap,n,i,a);s.push(...e)}if("n"===c){const e=f(n,i);s.push(...e)}if("p"===c){const e=g(n,i,u,r);s.push(...e)}if("b"===c){const e=p(this.squaresMap,n,i,a);s.push(...e)}if("q"===c){const e=m(this.squaresMap,n,i,a),t=p(this.squaresMap,n,i,a);s.push(...e,...t)}if("k"===c){const e=q(n,i);s.push(...e)}return s}drawDomainByColor(e=!0){this.drawClearDomains(e),e?this.state.isDomainWhiteOn=!0:this.state.isDomainBlackOn=!0;const t=v(e),r=[];return this.squaresMap.forEach(((t,a)=>{if(t&&t.color===e){const e=this.getSquarePieceAllowedSquares(a);r.push(...e)}})),r.forEach((e=>{document.getElementById(`base-${e}`).classList.add(t)})),r}drawDomainBySquare(e){const t=this.squaresMap.get(e);if(t){const r=M(t.color);this.addMarkerToSquare(e,r),this.getSquarePieceAllowedSquares(e).forEach((e=>{const r=v(t.color);document.getElementById(`base-${e}`).classList.add(r)}))}}drawClearDomains(e=!0){e?this.state.isDomainWhiteOn=!1:this.state.isDomainBlackOn=!1;const t=v(e);this.squaresMap.forEach(((e,r)=>{document.getElementById(`base-${r}`).classList.remove(t)}))}drawAttackFromSquare(e){if(!e)return;const t=this.squaresMap.get(e);if(t){const r=this.getSquarePieceAllowedSquares(e),a=M(t.color);r.forEach((e=>{const r=this.squaresMap.get(e);r&&r.color!==t.color&&this.addMarkerToSquare(e,a)}))}}drawAttackFromSquareDomain(e){if(!e)return;const t=this.squaresMap.get(e);if(t){const r=M(t.color),a=this.getSquarePieceAllowedSquares(e);this.drawDomainBySquare(e),a.forEach((a=>{const s=t;this.getSquarePieceAllowedSquares(a,s).forEach((s=>{const o=this.squaresMap.get(s);o&&o.color!==t.color&&(this.addMarkerToSquare(e,"marker-circle-neutral"),this.addMarkerToSquare(a,r),this.addMarkerToSquare(s,r))}))}))}}drawDangerToSquare(e){if(!e)return;let t=!0;const r=this.squaresMap.get(e);if(r)if(this.squaresMap.forEach(((a,s)=>{if(s!==e&&a&&a.color!==r.color&&this.getSquarePieceAllowedSquares(s).includes(e)){t=!1;const e=M(a.color);this.addMarkerToSquare(s,e),this.drawDomainBySquare(s)}})),t)this.addMarkerToSquare(e,"marker-rect-ok");else{const t=M(r.color);this.addMarkerToSquare(e,t)}}drawDangerToSquareDomain(e){if(!e)return;let t=!0;const r=this.squaresMap.get(e);if(r){const a=this.getSquarePieceAllowedSquares(e);a.forEach((s=>{this.drawDomainBySquare(e),this.squaresMap.forEach(((s,o)=>{if(o!==e&&s&&s.color!==r.color){const e=this.getSquarePieceAllowedSquares(o),r=a.filter((t=>e.includes(t)));r.forEach((e=>{const t=M(s.color);this.addMarkerToSquare(o,t),this.addMarkerToSquare(e,t)})),r.length>0&&(t=!1)}}))})),t?this.addMarkerToSquare(e,"marker-rect-ok"):this.addMarkerToSquare(e,"marker-circle-neutral")}}drawSupportToSquare(e){if(!e)return;let t=!1;const r=this.squaresMap.get(e);r&&(this.squaresMap.forEach(((a,s)=>{if(s!==e&&a&&a.color===r.color){const r=this.getSquarePieceAllowedSquares(s);if(console.debug("[CHESS] drawSupportToSquare: mapOptions",r),r.includes(e)){t=!0;const e=M(a.color);this.addMarkerToSquare(s,e),this.drawDomainBySquare(s)}}})),t?this.addMarkerToSquare(e,"marker-rect-ok"):this.addMarkerToSquare(e,"marker-rect-error"))}drawSupportToSquareDomain(e){if(!e)return;let t=!1;const r=this.squaresMap.get(e);if(r){this.drawDomainBySquare(e);const a=this.getSquarePieceAllowedSquares(e);a.forEach((s=>{this.squaresMap.forEach(((s,o)=>{if(o!==e&&s&&s.color===r.color){const e=this.getSquarePieceAllowedSquares(o),r=a.filter((t=>e.includes(t)));r.forEach((e=>{const t=M(s.color);this.addMarkerToSquare(o,t),this.addMarkerToSquare(e,t)})),r.length>0&&(t=!0)}}))})),t?this.addMarkerToSquare(e,"marker-circle-neutral"):this.addMarkerToSquare(e,"marker-rect-error")}}get actionsBridge(){return{onShowSquareSupport:e=>{this.drawSupportToSquare(e)},onShowSquareDomainSupport:e=>{this.drawSupportToSquareDomain(e)},onFlip:()=>{this.flipBoard()},movePiecesFromSquares:async(e,t)=>this.move(e,t),onAddMarker:(e,t)=>{this.addMarkerToSquare(e,t,!0)},onAdd:(e,t,r)=>{if(!e)return;this.setFigureInSquare(e,t,r);const a=d.parseMapToFenStr(this.squaresMap);d.changeHistoryWithFen(a),this.drawPiecesFromMap()},onClearSquare:e=>{if(!e)return;this.setFigureInSquare(e,null);const t=d.parseMapToFenStr(this.squaresMap);d.changeHistoryWithFen(t),this.drawPiecesFromMap()},onClear:()=>{this.squaresMap=d.createSquaresMap(t,r),this.drawPiecesFromMap();const e=d.parseMapToFenStr(this.squaresMap);d.changeHistoryWithFen(e),this.movesRegistry.reset(),this.movesRegistry.record()},onInit:()=>{this.fenToMap(a),this.drawPiecesFromMap(),d.changeHistoryWithFen(a),this.movesRegistry.reset(),this.movesRegistry.record()},onDomainW:async()=>{this.state.isDomainWhiteOn?this.drawClearDomains(o):this.drawDomainByColor(o)},onDomainB:async()=>{this.state.isDomainBlackOn?this.drawClearDomains(n):this.drawDomainByColor(n)},onDomainsToggle:async()=>{this.state.isDomainWhiteOn||this.state.isDomainBlackOn?(this.drawClearDomains(o),this.drawClearDomains(n)):(this.drawDomainByColor(o),this.drawDomainByColor(n))},onDomainsSquare:async e=>{this.drawDomainBySquare(e)},onDomainDangerSquare:async e=>{this.drawDangerToSquareDomain(e)},onDomainAttacksSquare:async e=>{this.drawAttackFromSquareDomain(e)},onShowAttackSquare:async e=>{this.drawAttackFromSquare(e)},onDangerSquare:async e=>{this.drawDangerToSquare(e)},onRemoveVisuals:()=>{this.drawRemoveAllMarkers(),this.drawClearDomains(o),this.drawClearDomains(n)},onToggleMarkers:()=>{F()},onLoadFenFromInput:()=>{this.loadFenFromInput()},onLoadFenToInput:()=>{this.loadFenToInput()},onCreateLink:()=>{const e=d.parseMapToFenStr(this.squaresMap),t=d.getAbsoluteRouteWithFen(e);C(t)},onNavPrev:()=>{const e=this.movesRegistry.prevMove;console.log(e),e&&this.drawFromMove(e)},onNavNext:()=>{const e=this.movesRegistry.nextMove;e&&this.drawFromMove(e)},onNavRecord:()=>{this.record()},onLoadPgn:()=>{this.loadPgnFromInput()}}}}(x)})();
//# sourceMappingURL=main.390989b4500b58928062.js.map