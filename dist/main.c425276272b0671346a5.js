(()=>{"use strict";class e{constructor(e){this.letterW=e.letterW,this.iconW=e.iconW,this.letterB=e.letterB,this.iconB=e.iconB}asLetter(e=!0){return e?this.letterW:this.letterB}asIcon(e=!0){return e?this.iconW:this.iconB}}const t=[8,7,6,5,4,3,2,1],r=["a","b","c","d","e","f","g","h"],a="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",s=!0,o=!1,n={b:new e({letterW:"B",iconW:"♗",letterB:"b",iconB:"♝"}),r:new e({letterW:"R",iconW:"♖",letterB:"r",iconB:"♜"}),n:new e({letterW:"N",iconW:"♘",letterB:"n",iconB:"♞"}),k:new e({letterW:"K",iconW:"♔",letterB:"k",iconB:"♚"}),q:new e({letterW:"Q",iconW:"♕",letterB:"q",iconB:"♛"}),p:new e({letterW:"P",iconW:"♙",letterB:"p",iconB:"♟"})};function i(e,t){return`${e}${t}`}function c(e,t=!0){return e?{letter:e,color:t}:null}const l={getCellKey:i,createSquaresMap:function(e,t){const r=[];return e.forEach((e=>{t.forEach((t=>{const a=i(t,e);r.push([a,null])}))})),new Map(r)},createMarkersMap:function(e,t){const r=[];return e.forEach((e=>{t.forEach((t=>{const a=i(t,e);r.push([a,[]])}))})),new Map(r)},parseFenStrToObject:function(e){const t={},a=["r","n","b","k","q","p","R","N","B","K","Q","P"];return e.split(" ")[0].split("/").forEach(((e,s)=>{const o=8-s;let n=1;e.split("").forEach((e=>{if(a.includes(e)){const a=i(r[n-1],o),s=e==e.toUpperCase(),l=e.toLowerCase();t[a]=c(l,s),n+=1}else{const a=parseInt(e,10);for(let e=n;e<a+n;e++){const a=i(r[e-1],o);t[a]=null}n+=parseInt(e,10)}}))})),t},parseMapToFenStr:function(e){const t=[8,7,6,5,4,3,2,1],r=["a","b","c","d","e","f","g","h"];let a="",s=0;return t.forEach(((o,n)=>{s=0,r.forEach((t=>{const r=i(t,o),n=e.get(r);if(n){0!==s&&(a+=s.toString(),s=0);const e=n.color?n.letter.toUpperCase():n.letter.toLowerCase();a+=e}else s+=1})),0!==s&&(a+=s.toString()),n<t.length-1&&(a+="/")})),a},asSquare:c};class u{constructor(){this.moves=[],this.moveIdx=0}saveMove(e,t,r){const a={from:e,to:t,fen:l.parseMapToFenStr(r)};this.moves.push(a),this.moveIdx=this.moves.length-1}get currentMoveIdx(){return this.moveIdx}}const d=function(e,t,a,s=!1){const o=r.indexOf(t),n=[];for(let r=a-1;r>=1;r--){n.push(l.getCellKey(t,r));const a=n[n.length-1];if(e.get(a)&&s)break}for(let r=a+1;r<=8;r++){n.push(l.getCellKey(t,r));const a=n[n.length-1];if(e.get(a)&&s)break}for(let t=o+1;t<r.length;t++){n.push(l.getCellKey(r[t],a));const o=n[n.length-1];if(e.get(o)&&s)break}for(let t=o-1;t>=0;t--){n.push(l.getCellKey(r[t],a));const o=n[n.length-1];if(e.get(o)&&s)break}return n},h=function(e,t){const a=r.indexOf(e),s=[];return[[2,1],[1,2],[-1,2],[-2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]].forEach((e=>{const o=t+e[0],n=a+e[1];n>=0&&n<r.length&&o>0&&o<=8&&s.push(l.getCellKey(r[n],o))})),s},m=function(e,t,a){const s=r.indexOf(e),o=[],n=a?t+1:t-1;return[[1,n],[-1,n]].forEach((e=>{const t=s+e[0],a=e[1];t>=0&&t<r.length&&a>0&&a<=8&&o.push(l.getCellKey(r[t],a))})),o},f=function(e,t,a,s=!1){const o=r.indexOf(t),n=[];let i=1;for(let t=a-1;t>=0;t--){const a=o+i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(l.getCellKey(r[a],t)),i++;const o=n[n.length-1];if(e.get(o)&&s)break}}i=1;for(let t=a-1;t>=0;t--){const a=o-i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(l.getCellKey(r[a],t)),i++;const o=n[n.length-1];if(e.get(o)&&s)break}}i=1;for(let t=a+1;t<=8;t++){const a=o-i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(l.getCellKey(r[a],t)),i++;const o=n[n.length-1];if(e.get(o)&&s)break}}i=1;for(let t=a+1;t<=8;t++){const a=o+i;if(a>=0&&a<r.length&&t>0&&t<=8){n.push(l.getCellKey(r[a],t)),i++;const o=n[n.length-1];if(e.get(o)&&s)break}}return n},g=function(e,t){const a=r.indexOf(e),s=[];return[[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1]].forEach((e=>{const o=a+e[0],n=t+e[1];o>=0&&o<r.length&&n>0&&n<=8&&s.push(l.getCellKey(r[o],n))})),s},p=90/8,q=function(e,t=null){let r="neutral";t===s?r="white":!1===t&&(r="black");const a=document.getElementById(`markers-${e}`),o=document.createElementNS("http://www.w3.org/2000/svg","use");o.setAttribute("href",`#marker-circle-${r}`),o.setAttribute("data-square",`${e}`),a.appendChild(o)},k=function(e,t=!0){let r=t?"ok":"error";const a=document.getElementById(`markers-${e}`),s=document.createElementNS("http://www.w3.org/2000/svg","use");s.setAttribute("href",`#marker-rect-${r}`),s.setAttribute("data-square",`${e}`),a.appendChild(s)},S=function(e){const t=document.getElementById(`markers-${e}`),r=document.createElementNS("http://www.w3.org/2000/svg","use");r.setAttribute("href","#marker-move-last"),r.setAttribute("data-square",`${e}`),t.appendChild(r)},w=function(e,t,r,a,s=!0){const o=l.getCellKey(e,r),n=p*t,i=p*a,c=`\n        <title>${o}</title>\n        <rect id="base-${o}" \n            data-square="${o}"\n            class="base" \n            width="11.25%" \n            height="11.25%"  />\n        <g id="markers-${o}" \n            data-square="${o}"\n            class="markers" \n            width="11.25%" \n            height="11.25%"  \n            fill="transparent"\n            />\n        <text id="piece-${o}" \n            data-square="${o}"\n            class="piece ${s?"asIcon":""}" \n            text-anchor="start" \n            x="${s?1.5:4}" \n            y="${s?-1.5:8}" \n            dy="${s?10:0}"\n         ></text>\n    `,u=document.createElementNS("http://www.w3.org/2000/svg","g");return u.setAttribute("class","square"),u.setAttribute("id",`${o}`),u.setAttribute("data-square",`${o}`),u.setAttribute("data-square-col",`${e}`),u.setAttribute("data-square-row",`${r}`),u.setAttribute("transform",`translate(${n},${i})`),u.innerHTML=c,u},B=function(e,t="",r=!0){const a=document.getElementById(`piece-${e}`),s=r?"white":"black";a.classList.add(s);const o=r?"black":"white";r&&a.classList.contains(o)&&a.classList.remove(o),a.textContent=t},b=function(e,t){const r=[];return t.forEach(((e,t)=>{const a=document.createElementNS("http://www.w3.org/2000/svg","text"),s=document.createTextNode(e);a.setAttribute("x",p*t+"%"),a.setAttribute("y","0"),a.setAttribute("dy","0"),a.setAttribute("dx","1"),a.setAttribute("data-coord-col",`${e}`),a.setAttribute("class","board-coordinate board-coordinate-col"),a.setAttribute("text-anchor","start"),a.appendChild(s),r.push(a)})),e.forEach(((e,t)=>{const a=document.createElementNS("http://www.w3.org/2000/svg","text"),s=document.createTextNode(e);a.setAttribute("x","0"),a.setAttribute("y",p*t+"%"),a.setAttribute("dy","6"),a.setAttribute("dx","-3"),a.setAttribute("data-coord-row",`${e}`),a.setAttribute("class","board-coordinate board-coordinate-row"),a.setAttribute("text-anchor","start"),a.appendChild(s),r.push(a)})),r},M=function(e){const t=document.getElementById(`markers-${e}`).children;for(var r=t.length-1;r>=0;--r)t[r].remove()},y=function(){const e=document.querySelectorAll(".markers"),t="marker-invisible";e.forEach((e=>{e.classList.contains(t)?e.classList.remove(t):e.classList.add(t)}))};class E{constructor(e){this.buffer={squareTarget:null},this.callBacks=e,this.panelControls()}squareControls(){const e=this;document.querySelectorAll(".square").forEach((t=>{t.addEventListener("click",(function(t){const r=(t.target||t.srcElement).getAttribute("data-square");e.checkOnSelectSquare(r)}),!1)}))}async checkOnSelectSquare(e){this.buffer.squareTarget?e===this.buffer.squareTarget||await this.callBacks.movePiecesFromSquares(this.buffer.squareTarget,e)?this.clearBufferAndSelection():(this.clearSelectedSquareFromBuffer(),this.setBufferSquareTarget(e)):this.setBufferSquareTarget(e)}panelControls(){const e=this;document.querySelectorAll(".button-add-fig").forEach((t=>{t.addEventListener("click",(function(t){const r=(t.target||t.srcElement).getAttribute("data-letter"),a=r===r.toUpperCase();e.callBacks.onAdd(e.buffer.squareTarget,r.toLowerCase(),a),e.clearSelectedSquareFromBuffer()}),!1)})),document.querySelectorAll(".button-marker").forEach((t=>{t.addEventListener("click",(function(t){const r=t.currentTarget.getAttribute("data-marker-id");e.callBacks.onAddMarker(e.buffer.squareTarget,r),e.clearSelectedSquareFromBuffer()}),!1)})),document.getElementById("button-clear-square").addEventListener("click",(function(){e.callBacks.onClearSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-domains-w").addEventListener("click",(function(){e.callBacks.onDomainW()}),!1),document.getElementById("button-paint-domains-b").addEventListener("click",(function(){e.callBacks.onDomainB()}),!1),document.getElementById("button-clear").addEventListener("click",(function(){e.callBacks.onClear()}),!1),document.getElementById("button-init").addEventListener("click",(function(){e.callBacks.onInit()}),!1),document.getElementById("button-toggle-domains").addEventListener("click",(function(){e.callBacks.onDomainsToggle()}),!1),document.getElementById("button-paint-domains-square").addEventListener("click",(function(){e.callBacks.onDomainsSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-domain-attack-square").addEventListener("click",(function(){e.callBacks.onDomainAttacksSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-attack-square").addEventListener("click",(function(){e.callBacks.onAttacksSquare(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-board-flip").addEventListener("click",(function(){e.callBacks.onFlip(e.buffer.squareTarget)}),!1),document.getElementById("button-paint-support-square").addEventListener("click",(function(){e.callBacks.onShowSquareSupport(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-paint-support-square-domain").addEventListener("click",(function(){e.callBacks.onShowSquareDomainSupport(e.buffer.squareTarget),e.clearSelectedSquareFromBuffer()}),!1),document.getElementById("button-visuals-remove").addEventListener("click",(function(){e.callBacks.onRemoveVisuals()}),!1),document.getElementById("button-markers-toggle").addEventListener("click",(function(){e.callBacks.onToggleMarkers()}),!1),document.getElementById("button-fen-load").addEventListener("click",(function(){e.callBacks.onLoadFenFromInput()}),!1)}async setBufferSquareTarget(e){if(this.buffer.squareTarget=e,e){const t=document.getElementById(`base-${e}`);t.classList.contains("with-selection")?t.classList.remove("with-selection"):t.classList.add("with-selection")}}clearSelectedSquareFromBuffer(){const e=this.buffer.squareTarget;if(e){const t=document.getElementById(`base-${e}`);t.classList.contains("with-selection")&&t.classList.remove("with-selection"),this.buffer.squareTarget=null}}clearBufferAndSelection(){this.buffer.squareTarget=null,document.querySelectorAll(".base").forEach((e=>{e.classList.remove("with-selection")}))}}new class{constructor(e){this.config={flip:"flip"in e&&e.flip,asIcon:!("asIcon"in e)||e.asIcon,asLines:!("asLines"in e)||e.asLines,withLimitation:"withLimitation"in e&&e.withLimitation},this.figures=n,this.colors={white:s,black:o},this.movesRegistry=new u,this.squaresMap=l.createSquaresMap(t,r),this.markersMap=l.createMarkersMap(t,r);const i="fen"in e?e.fen:a;this.fenToMap(i),this.render(),this.chessControls=new E(this.actionsBridge),this.state={isDomainWhiteOn:!1,isDomainBlackOn:!1}}lab(){}labMoves(){this.move("e2","e4"),this.move("d5","e4"),this.move("d2","e4"),this.move("f6","f5"),console.log(this.movesRegistry.moves),console.log(this.movesRegistry.currentMoveIdx),setTimeout((()=>{this.jumpToMove(1)}),1e3)}fenToMap(e){if(!e||""===e)return;const t=l.parseFenStrToObject(e);this.squaresMap=new Map(Object.entries(t))}async render(){this.drawBoard().then((()=>{this.chessControls.squareControls(),this.lab()}))}flipBoard(){this.config.flip=!this.config.flip;const e=document.querySelectorAll(".square"),t=document.querySelectorAll(".board-coordinate");e.forEach((e=>{e.remove()})),t.forEach((e=>{e.remove()})),this.render()}async move(e,t){console.log("[CHESS] move");const r=this.squaresMap.get(e);if(r)return this.setFigureInSquare(t,r.letter,r.color),this.setFigureInSquare(e,null),this.drawPiecesFromMap(),this.movesRegistry.saveMove(e,t,this.squaresMap),!0}loadFenFromInput(){const e=document.getElementById("fen-input").value;this.fenToMap(e),this.drawPiecesFromMap()}jumpToMove(e){const t=this.movesRegistry.moves[e];this.fenToMap(t.fen),this.drawPiecesFromMap(),this.drawMarkerInSquare(t.from,"marker-move-last"),this.drawMarkerInSquare(t.to,"marker-move-last")}setFigureInSquare(e,t,r=!0){this.squaresMap.set(e,l.asSquare(t,r))}addMarkerToSquare(e,t,r=!1){if(!e)return;const a=this.markersMap.get(e),s=a.indexOf(t);-1===s&&(a.push(t),this.markersMap.set(e,a),this.drawMarkerInSquare(e,t)),r&&s>-1&&(a.splice(s,1),console.log(a),this.markersMap.set(e,a),this.drawMarkersFromMapBySquareName(e))}async drawBoard(){const e=document.getElementById("svg-squares"),a=document.getElementById("svg-coordinates"),s=this.config.flip,o=s?[...t].reverse():t,n=s?[...r].reverse():r;o.forEach(((t,r)=>{n.forEach(((a,s)=>{const o=w(a,s,t,r,this.config.asIcon);e.appendChild(o)}))})),this.drawPiecesFromMap(),b(o,n).forEach((e=>{a.appendChild(e)}))}drawPiecesFromMap(){this.squaresMap.forEach(((e,t)=>{if(e){let r="";const a=n[e.letter];r=!0===this.config.asIcon?a.asIcon(e.color):a.asLetter(e.color),B(t,r,e.color)}else B(t)}))}drawMarkersFromMap(){this.markersMap.forEach(((e,t)=>{M(t),e.forEach((e=>{this.drawMarkerInSquare(t,e)}))}))}drawMarkersFromMapBySquareName(e){M(e),this.markersMap.get(e).forEach((t=>{this.drawMarkerInSquare(e,t)}))}drawMarkerInSquare(e,t){switch(t){case"cw":case"marker-circle-white":q(e,!0);break;case"cn":case"marker-circle-neutral":q(e);break;case"cb":case"marker-circle-black":q(e,!1);break;case"m":case"marker-move-last":S(e);break;case"ro":case"marker-rect-ok":k(e,!0);break;case"re":case"marker-rect-error":k(e,!1)}}getMarkerCircleIdByColor(e){return e?"marker-circle-white":"marker-circle-black"}drawRemoveAllMarkers(){this.markersMap=l.createMarkersMap(t,r),this.drawMarkersFromMap()}getSquarePieceAllowedSquares(e){const t=this.config.withLimitation,r=[];if(!e)return;const a=e.split(""),s=a[0],o=parseInt(a[1],10),{letter:n,color:i}=this.squaresMap.get(e);if("r"===n){const e=d(this.squaresMap,s,o,t);r.push(...e)}if("n"===n){const e=h(s,o);r.push(...e)}if("p"===n){const e=m(s,o,i);r.push(...e)}if("b"===n){const e=f(this.squaresMap,s,o,t);r.push(...e)}if("q"===n){const e=d(this.squaresMap,s,o,t),a=f(this.squaresMap,s,o,t);r.push(...e,...a)}if("k"===n){const e=g(s,o);r.push(...e)}return r}getDomainClassNameByColor(e){return e?"with-domain-white":"with-domain-black"}drawDomainByColor(e=!0){e?this.state.isDomainWhiteOn=!0:this.state.isDomainBlackOn=!0;const t=this.getDomainClassNameByColor(e),r=[];this.squaresMap.forEach(((t,a)=>{if(t&&t.color===e){const e=this.getSquarePieceAllowedSquares(a);r.push(...e)}})),r.forEach((e=>{document.getElementById(`base-${e}`).classList.add(t)}))}drawDomainBySquare(e){const t=this.squaresMap.get(e);if(t){const r=this.getMarkerCircleIdByColor(t.color);this.addMarkerToSquare(e,r),this.getSquarePieceAllowedSquares(e).forEach((e=>{const r=this.getDomainClassNameByColor(t.color);document.getElementById(`base-${e}`).classList.add(r)}))}}drawClearDomains(e=!0){e?this.state.isDomainWhiteOn=!1:this.state.isDomainBlackOn=!1;const t=this.getDomainClassNameByColor(e);this.squaresMap.forEach(((e,r)=>{document.getElementById(`base-${r}`).classList.remove(t)}))}drawAttacksToSquare(e){if(!e)return;let t=!0;const r=this.squaresMap.get(e);if(r)if(this.squaresMap.forEach(((a,s)=>{if(s!==e&&a&&a.color!==r.color&&this.getSquarePieceAllowedSquares(s).includes(e)){t=!1;const e=this.getMarkerCircleIdByColor(a.color);this.addMarkerToSquare(s,e),this.drawDomainBySquare(s)}})),t)this.addMarkerToSquare(e,"marker-rect-ok");else{const t=this.getMarkerCircleIdByColor(r.color);this.addMarkerToSquare(e,t)}}drawAttacksToSquareDomain(e){if(!e)return;let t=!0;const r=this.squaresMap.get(e);if(r){const a=this.getSquarePieceAllowedSquares(e);if(a.forEach((s=>{const o=this.getDomainClassNameByColor(r.color);document.getElementById(`base-${s}`).classList.add(o),this.squaresMap.forEach(((s,o)=>{if(o!==e&&s&&s.color!==r.color){const e=this.getSquarePieceAllowedSquares(o),r=a.filter((t=>e.includes(t)));r.forEach((e=>{const t=this.getMarkerCircleIdByColor(s.color);this.addMarkerToSquare(o,t),this.addMarkerToSquare(e,"marker-circle-neutral")})),r.length>0&&(t=!1)}}))})),t)this.addMarkerToSquare(e,"marker-rect-ok");else{const t=this.getMarkerCircleIdByColor(r.color);this.addMarkerToSquare(e,t)}}}drawSupportToSquare(e){if(console.log("[CHESS] drawSupportToSquare:",e),!e)return;let t=!1;const r=this.squaresMap.get(e);r&&(this.squaresMap.forEach(((a,s)=>{if(s!==e&&a&&a.color===r.color){const r=this.getSquarePieceAllowedSquares(s);if(console.debug("[CHESS] drawSupportToSquare: mapOptions",r),r.includes(e)){t=!0;const e=this.getMarkerCircleIdByColor(a.color);this.addMarkerToSquare(s,e),this.drawDomainBySquare(s)}}})),t?this.addMarkerToSquare(e,"marker-rect-ok"):this.addMarkerToSquare(e,"marker-rect-error"))}drawSupportToSquareDomain(e){if(!e)return;let t=!1;const r=this.squaresMap.get(e);if(r){const a=this.getSquarePieceAllowedSquares(e);a.forEach((s=>{const o=this.getDomainClassNameByColor(r.color);document.getElementById(`base-${s}`).classList.add(o),this.squaresMap.forEach(((s,o)=>{if(o!==e&&s&&s.color===r.color){const e=this.getSquarePieceAllowedSquares(o),r=a.filter((t=>e.includes(t)));r.forEach((e=>{const t=this.getMarkerCircleIdByColor(s.color);this.addMarkerToSquare(o,t),this.addMarkerToSquare(e,"marker-circle-neutral")})),r.length>0&&(t=!0)}}))})),t?this.addMarkerToSquare(e,"marker-rect-ok"):this.addMarkerToSquare(e,"marker-rect-error")}}get actionsBridge(){return{onShowSquareSupport:e=>{this.drawSupportToSquare(e)},onShowSquareDomainSupport:e=>{this.drawSupportToSquareDomain(e)},onFlip:()=>{this.flipBoard()},movePiecesFromSquares:async(e,t)=>this.move(e,t),onAddMarker:(e,t)=>{this.addMarkerToSquare(e,t,!0)},onAdd:(e,t,r)=>{e&&(this.setFigureInSquare(e,t,r),this.drawPiecesFromMap())},onClearSquare:e=>{e&&(this.setFigureInSquare(e,null),this.drawPiecesFromMap())},onClear:()=>{this.squaresMap=l.createSquaresMap(t,r),this.drawPiecesFromMap()},onInit:()=>{this.fenToMap(a),this.drawPiecesFromMap()},onDomainW:async()=>{this.state.isDomainWhiteOn?this.drawClearDomains(s):this.drawDomainByColor(s)},onDomainB:async()=>{this.state.isDomainBlackOn?this.drawClearDomains(o):this.drawDomainByColor(o)},onDomainsToggle:async()=>{this.state.isDomainWhiteOn||this.state.isDomainBlackOn?(this.drawClearDomains(s),this.drawClearDomains(o)):(this.drawDomainByColor(s),this.drawDomainByColor(o))},onDomainsSquare:async e=>{this.drawDomainBySquare(e)},onDomainAttacksSquare:async e=>{this.drawAttacksToSquareDomain(e)},onAttacksSquare:async e=>{this.drawAttacksToSquare(e)},onRemoveVisuals:()=>{this.drawRemoveAllMarkers(),this.drawClearDomains(s),this.drawClearDomains(o)},onToggleMarkers:()=>{y()},onLoadFenFromInput:()=>{this.loadFenFromInput()}}}}({asIcon:!0,asLines:!0,withLimitation:!0,flip:!1})})();
//# sourceMappingURL=main.c425276272b0671346a5.js.map